const JsonURLS={Head:"Data/Head.json",Torso:"Data/Torso.json",Arms:"Data/Arms.json",Waist:"Data/Waist.json",Legs:"Data/Legs.json",Skills:"Data/Skills.json",Decos:"Data/Decorations.json"},Decoration_Level_IMG=["Assets/deco1.png","Assets/deco2.png","Assets/deco3.png"];let charmTable,Jsons={},ResultSkills={Weapon:{},Head:{},Torso:{},Arms:{},Waist:{},Legs:{},Charm:{},HeadDeco:{},TorsoDeco:{},ArmsDeco:{},WaistDeco:{},LegsDeco:{},CharmDeco:{},WeaponDeco:{}};async function fetchJson(e){return hasKey=e in Jsons,hasKey?Jsons[e]:fetch(JsonURLS[e]).then(t=>(Jsons[e]=t.json(),Jsons[e]))}async function getJson(e,t){return null!=typeof t&&1!=t?fetchJson(e):getCharmJson()}function getCharmJson(){let e=localStorage.getItem("charms","");return null==e||""==e||null==typeof e?{}:JSON.parse(e)}function setCharmJson(e){localStorage.setItem("charms",JSON.stringify(e))}function removeCharm(e){let t=getCharmJson();delete t[e],setCharmJson(t)}function decorationSlotStringify(e){return 0==Object.keys(e).length?"0":1==Object.keys(e).length?`${e.Slot_1}`:2==Object.keys(e).length?`${e.Slot_1} - ${e.Slot_2}`:3==Object.keys(e).length?`${e.Slot_1} - ${e.Slot_2} - ${e.Slot_3}`:void 0}function parseDecorationSlots(e){let t={};return"0"==e[0]?t:(t.Slot_1=parseInt(e[0]),"0"==e[1]?t:(t.Slot_2=parseInt(e[1]),"0"==e[2]?t:(t.Slot_3=parseInt(e[2]),t)))}async function injectSkillToSkillsDisplayer(e,t){const l=await getJson("Skills");let n=document.createElement("div");n.setAttribute("class","input-group input-group-sm mb-3 col-md-6 col-sm-12 w-auto mx-auto");let a=document.createElement("span");a.setAttribute("class",t[1]>=l[t[0]].Max_Level?"input-group-text text-success fw-bold":"input-group-text text-danger fw-bold"),a.textContent=t[1];let o=document.createElement("input");o.setAttribute("class","form-control"),o.setAttribute("disabled",""),o.setAttribute("value",t[0]),n.appendChild(a),n.appendChild(o),e.appendChild(n)}async function injectOptionToSelector(e,t,l){let n=document.createElement("option");n.setAttribute("value",t),n.textContent=l,e.appendChild(n)}async function injectDecoInputToDecoSelector(e,t,l,n){const a=await getJson("Decos");Object.entries(l).forEach(l=>{const o=l[0],c=l[1];let s=document.createElement("div");s.setAttribute("class","mt-2 d-flex");let i=document.createElement("div");i.setAttribute("class","me-2");let r=document.createElement("div");r.setAttribute("class","flex-grow-1");let m=document.createElement("img");m.setAttribute("width","31px"),m.setAttribute("src",Decoration_Level_IMG[c-1]);let u=document.createElement("select");u.setAttribute("style","width: 100%;"),u.setAttribute("class","form-select form-select-sm"),u.setAttribute("id",`${t.replace("PieceSelector","")}DecoSelector_${o}`),u.addEventListener("change",e=>{onNewDecoSelected(t.replace(t.charAt(0),t.charAt(0).toUpperCase()).replace("PieceSelector",""),n)}),injectOptionToSelector(u,"None","None"),Object.entries(a).forEach(e=>{const t=e[0],l=e[1].Level,n=e[1].Skill;c>=l&&injectOptionToSelector(u,t,n+` - ${l}`)}),i.appendChild(m),r.appendChild(u),s.appendChild(i),s.appendChild(r),e.appendChild(s)})}function injectCharmToCharmTable(e,t,l){charmTable.row.add([e,t[0],t[1],t[2],l]).draw()}async function showPieceSelectionItems(e,t,l){let n=document.getElementById(e);n.textContent="";const a=await getJson(t,l);Object.entries(a).forEach(e=>{injectOptionToSelector(n,e[0],e[0])}),await onNewPieceSelected(e,t,l)}async function onNewPieceSelected(e,t,l){const n=document.getElementById(e).value,a=await getJson(t,l),o=await a[n];let c=document.getElementById(e.replace("PieceSelector","")+"SkillsDisplayer"),s=document.getElementById(e.replace("PieceSelector","")+"DecorationsDisplayer");c.innerHTML="",s.innerHTML="",ResultSkills[t]={},ResultSkills[t+"Deco"]={},""!=n?o.Skills.length<=0||(Object.entries(o.Skills).forEach(e=>{const l=e[0],n=parseInt(e[1]);void 0===ResultSkills[t][l]?ResultSkills[t][l]=n:ResultSkills[t][l]+=n}),injectDecoInputToDecoSelector(s,e,o.Decoration_Slots,l),await displaySelectedPieceDetails(t,c)):await displaySetResult()}async function onNewDecoSelected(e,t){const l=await getJson("Decos"),n=document.querySelectorAll(`[id^='${e.toLowerCase()}DecoSelector_Slot']`);ResultSkills[e+"Deco"]={},n.forEach(t=>{const n=t.value;if("None"==n||null==typeof selectedItem||null==typeof selectedItem)return;const a=l[n].Skill;void 0===ResultSkills[e+"Deco"][a]?ResultSkills[e+"Deco"][a]=1:ResultSkills[e+"Deco"][a]+=1});let a=document.getElementById(e.toLowerCase()+"SkillsDisplayer");a.innerHTML="",await displaySelectedPieceDetails(e,a)}async function displaySelectedPieceDetails(e,t){const l=ResultSkills[e],n=ResultSkills[e+"Deco"];let a={};Object.entries(l).forEach(e=>{"null"!=e[0]&&(void 0===a[e[0]]?a[e[0]]=e[1]:a[e[0]]+=e[1])}),Object.entries(n).forEach(e=>{"null"!=e[0]&&(void 0===a[e[0]]?a[e[0]]=e[1]:a[e[0]]+=e[1])}),Object.entries(a).forEach(e=>{injectSkillToSkillsDisplayer(t,e)}),await displaySetResult()}async function displaySetResult(){let e=document.getElementById("setresultSkillDisplayer");e.innerHTML="";let t={};Object.entries(ResultSkills).forEach(e=>{Object.entries(e[1]).forEach(e=>{void 0===t[e[0]]?t[e[0]]=e[1]:t[e[0]]+=e[1]})});const l=await getJson("Skills");Object.entries(l).forEach(l=>{null!=t[l[0]]&&injectSkillToSkillsDisplayer(e,[l[0],t[l[0]]])})}function displayCharmsToTable(){const e=getCharmJson();charmTable.clear().draw(),Object.entries(e).forEach(e=>{const t=e[0],l=Object.entries(e[1]);let n=l[0][1];n=decorationSlotStringify(n);const a=["","",""];for(i=0;i<Object.keys(l[1][1]).length;i++){const e=Object.keys(l[1][1])[i];a[i]=e+" - "+l[1][1][e]}injectCharmToCharmTable(t,a,n)})}async function initCharmMaker(){const e=document.querySelectorAll("[id^='charmMakingSkillSelector']"),t=await getJson("Skills");e.forEach(e=>{injectOptionToSelector(e,"None","None")}),Object.entries(t).forEach(t=>{injectOptionToSelector(e[0],t[0],t[0]),injectOptionToSelector(e[1],t[0],t[0]),injectOptionToSelector(e[2],t[0],t[0])})}async function createCharm(e,t,l){let n=getCharmJson();if(null!=n[e])return alert("Charm's name must be unique");let a={};for(var o=0;o<l.length;o++){let e=l.charAt(o);if("0"==e)break;if("1"!=e&&"2"!=e&&"3"!=e)break;a[`Slot_${o+1}`]=parseInt(e)}const c=["","",""];for(o=0;o<Object.keys(t).length;o++){const e=Object.keys(t)[o];c[o]=e+" - "+t[e]}n[e]={},n[e].Decoration_Slots=a,n[e].Skills=t;document.getElementById("charmPieceSelector");injectCharmToCharmTable(e,c,decorationSlotStringify(a)),setCharmJson(n),await showPieceSelectionItems("charmPieceSelector","Charm",!0),alert(`${e} charm is created as successfully!`)}async function onNewWeaponSelected(){let e=document.getElementById("weaponSlotSelector"),t=document.getElementById("weaponDecorationsDisplayer"),l=parseDecorationSlots(e.value);t.innerHTML="",injectDecoInputToDecoSelector(t,"weaponPieceSelector",l)}async function initWeaponSlotSelector(){}async function main(){await showPieceSelectionItems("headPieceSelector","Head"),await showPieceSelectionItems("torsoPieceSelector","Torso"),await showPieceSelectionItems("armsPieceSelector","Arms"),await showPieceSelectionItems("waistPieceSelector","Waist"),await showPieceSelectionItems("legsPieceSelector","Legs"),await showPieceSelectionItems("charmPieceSelector","Charm",!0),await initCharmMaker(),await displayCharmsToTable(),await onNewWeaponSelected()}$(document).ready(function(){charmTable=$("#charmTable").DataTable({columnDefs:[{targets:-1,data:null,defaultContent:'<button type="button" class="btn btn-sm btn-danger"> <span> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">\n        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>\n        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>\n      </svg> </span>Delete</button>'}]}),$("#charmTable tbody").on("click","button",async function(){let e=charmTable.row($(this).parents("tr")[0]).data(),t=!1;null==e&&(e=charmTable.row($(this).parents("tr")[1]).data(),t=!0),confirm("Are you sure you want to delete this charm?")&&(removeCharm(e[0]),await showPieceSelectionItems("charmPieceSelector","Charm",!0),t?charmTable.row($(this).parents("tr")[1]).remove().draw():charmTable.row($(this).parents("tr")[0]).remove().draw())}),main()}),document.querySelectorAll("[id$='PieceSelector']").forEach(e=>{e.addEventListener("change",()=>{const t=e.getAttribute("id"),l=t.replace(t.charAt(0),t.charAt(0).toUpperCase()).replace("PieceSelector","");"Charm"==l?onNewPieceSelected(t,l,!0):onNewPieceSelected(t,l)})}),document.getElementById("weaponSlotSelector").addEventListener("change",e=>{onNewWeaponSelected()}),document.getElementById("createCharmBtn").addEventListener("click",async e=>{let t=document.getElementById("charmMakingName").value;if(""==t)return alert("Charm name can't be empty");if(t.length>16)return alert("Charm name must be less then 16 characters");let l=document.getElementById("charmMakingSkillSelector1"),n=document.getElementById("charmMakingLevelSelector1"),a=document.getElementById("charmMakingSkillSelector2"),o=document.getElementById("charmMakingLevelSelector2"),c=document.getElementById("charmMakingSkillSelector3"),s=document.getElementById("charmMakingLevelSelector3"),i=document.getElementById("charmMakingSlotSelector");skills={},"None"!=l.value&&"0"!=n.value&&(skills[l.value]=parseInt(n.value)),"None"!=a.value&&"0"!=o.value&&a.value!=l.value&&(skills[a.value]=parseInt(o.value)),"None"!=c.value&&"0"!=s.value&&c.value!=l.value&&c.value!=a.value&&(skills[c.value]=parseInt(s.value)),await createCharm(t,skills,i.value)});